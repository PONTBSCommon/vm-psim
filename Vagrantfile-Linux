#### Your MACHINE_NAME will be the hostname of your host machine and the name of your current folder with unsafe characters removed. eg: USER1-VMPSIM
#### From: https://support.microsoft.com/en-gb/help/909264/naming-conventions-in-active-directory-for-computers-domains-sites-and
#### NetBIOS computer names cannot contain the following characters: \ / : * ? " < > |
HOSTNAME = "#{`hostname`[0..-2]}-" + File.basename(Dir.getwd).gsub(/[^\w\s]/i,'').upcase

Vagrant.configure("2") do |c|
  #### (Required) always make sure you get the latest box when recreating your machine. ####
  c.vm.box_check_update = true
  c.vm.box = "pengboz/windows2016"
  c.vm.communicator = "winrm"
  # Replace "eno1" if necessary
  c.vm.network "public_network", bridge: "eno1"

  ### We will update vbguest when big version bump along with base image update.
  if Vagrant.has_plugin?("vagrant-vbguest")
    c.vbguest.auto_update = false
  end

  ### (Required)
  c.vm.network "forwarded_port", guest: 3389, host: 33389, auto_correct: true, id: "remote desktop connection"

  #### (Required) This section deals with naming the machine. ####
  c.vm.define "#{HOSTNAME.downcase}" # vagrant machine name
  c.vm.hostname = HOSTNAME # windows hostname
  c.vm.provider "virtualbox" do |v|
    v.name = "#{HOSTNAME}" # virtualbox name
    v.memory = 8192
    v.cpus = 2
  end

  #### (Required) install PSIM if the psim.exe and license.txt are present in the ./installer folder. ####
  c.vm.provision "shell", name: "Update License", privileged: true, reboot: false, keep_color: true, path: "scripts/ModifyLicense.ps1"
  c.vm.provision "shell", name: "PSIM Installer", privileged: true, reboot: true, keep_color: true, path: "scripts/PsimInstaller.ps1"
  c.vm.provision "shell", name: "First Run Setup", privileged: true, reboot: false, keep_color: true, path: "scripts/FirstRunRemoteSetup.ps1"
  c.vm.provision "shell", name: "Create TLS Cert", privileged: true, reboot: false, keep_color: true, path: "scripts/TLSCertCreation.ps1"
  c.vm.provision "shell", name: "Modify Tomcat", privileged: true, reboot: false, keep_color: true, path: "scripts/TomcatModification.ps1"
end